# Troubleshooting 502 Bad Gateway на Railway

## Проблема

После успешного деплоя вы получаете ошибку 502 Bad Gateway с "connection dial timeout" при открытии страницы.

## Причины

Ошибка 502 означает, что Railway не может подключиться к вашему приложению. Это может быть из-за:

1. **Приложение не запускается** - падает при старте
2. **Приложение не слушает правильный порт** - не использует переменную PORT
3. **Приложение запускается слишком долго** - превышает таймаут Railway
4. **Ошибки подключения к базе данных** - приложение падает при попытке подключиться

## Решение

### Шаг 1: Проверьте логи деплоя

1. Откройте ваш сервис в Railway
2. Перейдите в раздел "Deployments"
3. Откройте последний деплой
4. Просмотрите логи сборки и запуска

**Что искать:**
- Ошибки при выполнении миграций
- Ошибки подключения к базе данных
- Сообщения о запуске сервера
- Сообщение "Starting Django development server"

### Шаг 2: Проверьте переменные окружения

Убедитесь, что установлены:

1. **PORT** - Railway устанавливает автоматически, не нужно настраивать
2. **DATABASE_URL** - должен быть установлен, если PostgreSQL подключен
3. **SECRET_KEY** - обязателен для Django
4. **ALLOWED_HOSTS** - должен включать ваш Railway домен
5. **DEBUG** - установите в `0` для production

### Шаг 3: Проверьте подключение к базе данных

Если в логах есть ошибки подключения к базе:

1. Убедитесь, что PostgreSQL сервис запущен
2. Проверьте, что `DATABASE_URL` установлен в Variables
3. См. инструкции в `RAILWAY_SETUP.md`

### Шаг 4: Проверьте, что приложение запускается

В логах должны быть сообщения:
```
=== Starting Django application ===
PORT: [номер порта]
=== Running migrations ===
=== Migrations completed successfully ===
=== Starting Django development server ===
Listening on 0.0.0.0:[PORT]
```

Если этих сообщений нет - приложение не запускается.

### Шаг 5: Проверьте порт

Убедитесь, что приложение использует переменную `PORT`:

- В логах должно быть: `Listening on 0.0.0.0:[PORT]`
- PORT должен быть числом (обычно что-то вроде 3000, 5000, 8000)

### Шаг 6: Проверьте ALLOWED_HOSTS

В Variables вашего сервиса добавьте:

```
ALLOWED_HOSTS=canban-production-e108.up.railway.app,.railway.app,.up.railway.app
```

Или используйте ваш конкретный домен.

## Быстрое решение

1. **Проверьте логи** - найдите последнюю ошибку
2. **Проверьте DATABASE_URL** - должен быть установлен
3. **Проверьте SECRET_KEY** - должен быть установлен
4. **Проверьте ALLOWED_HOSTS** - должен включать ваш домен
5. **Перезапустите сервис** - нажмите "Redeploy"

## Типичные ошибки

### "Database migration failed"
- **Решение**: Проверьте `DATABASE_URL` и подключение к PostgreSQL

### "DisallowedHost at /"
- **Решение**: Добавьте ваш домен в `ALLOWED_HOSTS`

### "Port already in use"
- **Решение**: Убедитесь, что используете переменную `PORT`, а не жестко заданный порт

### Приложение не запускается вообще
- **Решение**: Проверьте логи на наличие синтаксических ошибок или проблем с зависимостями

## Дополнительная отладка

Если проблема сохраняется:

1. **Проверьте Railway статус** - убедитесь, что сервис запущен
2. **Проверьте ресурсы** - возможно, не хватает памяти/CPU
3. **Попробуйте локально** - запустите `docker-compose up` и проверьте, работает ли
4. **Свяжитесь с поддержкой Railway** - если ничего не помогает

## Проверка после исправления

После внесения изменений:

1. Дождитесь завершения деплоя
2. Проверьте логи - должны быть сообщения об успешном запуске
3. Откройте ваш домен - должна загрузиться страница
4. Если все еще 502 - подождите 1-2 минуты и попробуйте снова

